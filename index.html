<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generator Caption Ultimate Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1b26',
                            card: '#24283b',
                            border: '#414868',
                            text: '#c0caf5',
                            muted: '#565f89'
                        }
                    },
                    animation: {
                        'pulse-short': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) 2',
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #414868; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        .h-dvh { height: 100dvh; }
        body { overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg h-dvh overflow-hidden text-gray-800 dark:text-dark-text font-sans transition-colors duration-300">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`inline-block ${className}`}>
                {path}
            </svg>
        );
        
        const paths = {
            bag: <><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
            refresh: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
            copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
            check: <polyline points="20 6 9 17 4 12"/>,
            infinity: <path d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 1 0 0-8c-2 0-4 1.33-6 4Z"/>,
            wand: <><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></>,
            wa: <path d="M3 21l1.65-3.8a9 9 0 1 1 3.4 2.9L3 21" />,
            download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
            hash: <><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></>,
            edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
            list: <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
            moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>,
            sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
            arrowRight: <><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>,
            trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
            copyAll: <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>,
            x: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
            plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
            save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>,
            bold: <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>,
            italic: <line x1="19" y1="4" x2="10" y2="4"></line>,
            strike: <line x1="5" y1="12" x2="19" y2="12"></line>,
            mono: <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>,
            arrowUp: <><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></>,
            arrowDown: <><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></>
        };

        const INITIAL_TEMPLATES = {
            gadget: { label: "Gadget & Elektronik", opening: "{izin posting min|izin share min|izin lapak min|permisi posting min|numpang posting min|ijin posting admin}", conditions: "{baru|new|kondisi baru|fresh unit|belum pernah dipakai} {fullset|lengkap|kelengkapan lengkap|set lengkap}, {segel|masih segel|segel pabrik}, {garansi|bergaransi|jaminan} {resmi|official}", priceLabel: "{harga murah|harga terjangkau|best price|harga promo|harga spesial}", linkLabel: "{link pembelian|link beli|link checkout|link order|link pemesanan|link transaksi} COD di sini:", placeholder: "Contoh: Sony A6000 Kit" },
            fashion: { label: "Fashion & Baju", opening: "{Ready Stock|Hadir Lagi|New Arrival|Restock Sist|Koleksi Baru}", conditions: "{Bahan adem|Kualitas premium|Jahitan rapi|Nyaman dipakai} {All Size|Ukuran Lengkap|Tersedia M/L/XL}, {Warna cantik|Pilihan warna banyak}, {Real pict|Foto asli|Sesuai gambar}", priceLabel: "{Harga promo|Diskon khusus|Harga cantik|Murah meriah}", linkLabel: "{link pembelian|link beli|link checkout|link order|link pemesanan|link transaksi} COD di sini:", placeholder: "Contoh: Gamis Rayon Premium" },
            food: { label: "Makanan & Kuliner", opening: "{Open PO|Ready Hari Ini|Siap Antar|Fresh from Oven|Menu Baru}", conditions: "{Enak|Lezat|Gurih|Nikmat|Bikin nagih} {Tanpa pengawet|Bahan alami|100% Halal|Higienis}, {Made by order|Freshly made|Masih hangat}, {Bisa COD|Siap delivery}", priceLabel: "{Harga hemat|Paket hemat|Murah banget|Cuma}", linkLabel: "{link pembelian|link beli|link checkout|link order|link pemesanan|link transaksi} COD di sini:", placeholder: "Contoh: Sambal Cumi Pete" },
            services: { label: "Jasa & Layanan", opening: "{Open Jasa|Melayani|Siap Membantu|Butuh Bantuan?|Solusi Tepat}", conditions: "{Profesional|Berpengalaman|Terpercaya|Amanah}, {Pengerjaan cepat|Hasil rapi|On time}, {Free konsultasi|Garansi revisi|Layanan 24 jam}", priceLabel: "{Biaya terjangkau|Rate bersahabat|Harga nego|Mulai dari}", linkLabel: "{link pembelian|link beli|link checkout|link order|link pemesanan|link transaksi} COD di sini:", placeholder: "Contoh: Jasa Desain Logo" }
        };

        const processSpintax = (text) => {
            if (!text) return "";
            let result = text;
            while (result.match(/\{([^{}]+)\}/)) {
                result = result.replace(/\{([^{}]+)\}/g, (match, content) => {
                    const choices = content.split('|');
                    return choices[Math.floor(Math.random() * choices.length)];
                });
            }
            return result;
        };

        // --- AI LOGIC (Simulated) ---
        const TONE_MODIFIERS = {
            hype: {
                label: "Hype / Semangat",
                emojis: ["ðŸ”¥", "âš¡", "ðŸ˜±", "â€¼ï¸", "ðŸš€", "ðŸ’¯"],
                keywords: {"murah": "HARGA HANCUR", "bagus": "KEREN PARAH", "diskon": "DISKON GILA", "promo": "PROMO BOMBASTIS", "ready": "READY GAN"}
            },
            soft: {
                label: "Kalem / Soft",
                emojis: ["âœ¨", "ðŸŒ¸", "ðŸ¤", "ðŸƒ", "ðŸ§¸", "ðŸ«¶"],
                keywords: {"murah": "harga bersahabat", "bagus": "cantik banget", "diskon": "potongan harga", "promo": "special offer", "ready": "tersedia ya kak"}
            },
            urgent: {
                label: "Mendesak / Flash Sale",
                emojis: ["â³", "âš ï¸", "ðŸš¨", "ðŸƒâ€â™‚ï¸", "ðŸ’¨"],
                keywords: {"murah": "CUMA HARI INI", "bagus": "BEST SELLER", "diskon": "LAST CALL", "promo": "FLASH SALE", "ready": "STOK TERBATAS"}
            },
            formal: {
                label: "Profesional",
                emojis: ["âœ…", "â˜‘ï¸", "â–ªï¸", "ðŸ”¹"],
                keywords: {"murah": "harga kompetitif", "bagus": "kualitas terjamin", "diskon": "penawaran khusus", "promo": "promo terbatas", "ready": "ready stock"}
            }
        };

        const applyAiTone = (text, toneKey) => {
            if (!toneKey) return text;
            const config = TONE_MODIFIERS[toneKey];
            let modified = text;

            // 1. Replace Keywords
            Object.keys(config.keywords).forEach(key => {
                const regex = new RegExp(`\\b${key}\\b`, 'gi');
                modified = modified.replace(regex, config.keywords[key]);
            });

            // 2. Add Emojis to lines randomly
            const lines = modified.split('\n');
            const resultLines = lines.map(line => {
                if (line.trim().length > 10 && Math.random() > 0.6) {
                    const emoji = config.emojis[Math.floor(Math.random() * config.emojis.length)];
                    return `${emoji} ${line}`;
                }
                return line;
            });

            return resultLines.join('\n');
        };

        const generateHashtags = (keywords) => {
            if (!keywords.trim()) return "";
            const words = keywords.split(',').map(w => w.trim()).filter(w => w);
            const baseTags = words.map(w => `#${w.replace(/\s+/g, '')}`).join(' ');
            const genericTags = " #fyp #viral #rekomendasi #jualbelionline";
            return `\n${baseTags}${genericTags}`;
        };

        function CaptionGenerator() {
            const [darkMode, setDarkMode] = useState(false);
            const [activeTab, setActiveTab] = useState('manual');
            const [mobileView, setMobileView] = useState('input'); 
            
            // Category & Presets
            const [templates, setTemplates] = useState(INITIAL_TEMPLATES);
            const [selectedCategory, setSelectedCategory] = useState('gadget');
            const [showSavePreset, setShowSavePreset] = useState(false);
            const [newPresetName, setNewPresetName] = useState("");

            const [captionInput, setCaptionInput] = useState('');
            const [autoForm, setAutoForm] = useState({ productName: '', price: '', link: '', description: '' });
            const [hashtags, setHashtags] = useState('');
            const [idSettings, setIdSettings] = useState({ prefix: '', mode: 'random', startSeq: 1 });

            // AI Tone State
            const [selectedTone, setSelectedTone] = useState('');

            const [templateConfig, setTemplateConfig] = useState({
                opening: { enabled: true, text: INITIAL_TEMPLATES['gadget'].opening },
                conditions: { enabled: true, text: INITIAL_TEMPLATES['gadget'].conditions },
                priceLabel: { enabled: true, text: INITIAL_TEMPLATES['gadget'].priceLabel },
                linkLabel: { enabled: true, text: INITIAL_TEMPLATES['gadget'].linkLabel }
            });
            const [editingSection, setEditingSection] = useState(null);

            // Reorder State
            const [sectionOrder, setSectionOrder] = useState(['opening', 'productName', 'description', 'conditions', 'price', 'link', 'hashtags']);

            const [currentItem, setCurrentItem] = useState(null);
            const [isCopied, setIsCopied] = useState(false);
            const [copiedIndex, setCopiedIndex] = useState(null);
            const [usedIndices, setUsedIndices] = useState([]);
            const resultTextAreaRef = useRef(null);

            // Load Data
            useEffect(() => {
                const savedData = localStorage.getItem('captionGenData_v7_pro');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    setAutoForm(parsed.autoForm || { productName: '', price: '', link: '', description: '' });
                    setHashtags(parsed.hashtags || '');
                    setIdSettings(parsed.idSettings || { prefix: '', mode: 'random', startSeq: 1 });
                    setSelectedCategory(parsed.selectedCategory || 'gadget');
                    setDarkMode(parsed.darkMode || false);
                    if(parsed.currentItem) setCurrentItem(parsed.currentItem);
                    if(parsed.templates) setTemplates(parsed.templates); 
                    if(parsed.templateConfig) setTemplateConfig(parsed.templateConfig);
                    if(parsed.sectionOrder) setSectionOrder(parsed.sectionOrder);
                }
            }, []);

            // Save Data
            useEffect(() => {
                const dataToSave = {
                    autoForm, hashtags, idSettings, selectedCategory, darkMode, currentItem, templateConfig, templates, sectionOrder
                };
                localStorage.setItem('captionGenData_v7_pro', JSON.stringify(dataToSave));
                
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [autoForm, hashtags, idSettings, selectedCategory, darkMode, currentItem, templateConfig, templates, sectionOrder]);

            // Change Template Config when Category Changes
            useEffect(() => {
                const currentTemplate = templates[selectedCategory];
                if (currentTemplate) {
                    setTemplateConfig(prev => ({
                        opening: { ...prev.opening, text: currentTemplate.opening },
                        conditions: { ...prev.conditions, text: currentTemplate.conditions },
                        priceLabel: { ...prev.priceLabel, text: currentTemplate.priceLabel },
                        linkLabel: { ...prev.linkLabel, text: currentTemplate.linkLabel }
                    }));
                }
            }, [selectedCategory, templates]);

            // Construct Caption Live
            useEffect(() => {
                if (activeTab === 'auto') {
                    const tagString = generateHashtags(hashtags);
                    let caption = "";

                    sectionOrder.forEach(sectionId => {
                        switch(sectionId) {
                            case 'opening':
                                if (templateConfig.opening.enabled) caption += templateConfig.opening.text + "\n";
                                break;
                            case 'productName':
                                caption += (autoForm.productName || "[Nama Produk]") + "\n";
                                break;
                            case 'description':
                                if (autoForm.description) caption += autoForm.description + "\n";
                                break;
                            case 'conditions':
                                if (templateConfig.conditions.enabled) caption += templateConfig.conditions.text + "\n\n";
                                else caption += "\n";
                                break;
                            case 'price':
                                if (templateConfig.priceLabel.enabled) caption += `${templateConfig.priceLabel.text} : Rp.${autoForm.price || "..."}\n`;
                                else caption += `Rp.${autoForm.price || "..."}\n`;
                                break;
                            case 'link':
                                if (templateConfig.linkLabel.enabled) caption += `${templateConfig.linkLabel.text} ${autoForm.link || "..."}`;
                                else caption += `${autoForm.link || "..."}`;
                                break;
                            case 'hashtags':
                                caption += tagString;
                                break;
                        }
                    });

                    setCaptionInput(caption);
                }
            }, [activeTab, autoForm, hashtags, templateConfig, sectionOrder]);

            // --- FUNCTIONS ---

            const moveSection = (index, direction) => {
                const newOrder = [...sectionOrder];
                const targetIndex = direction === 'up' ? index - 1 : index + 1;
                
                if (targetIndex >= 0 && targetIndex < newOrder.length) {
                    [newOrder[index], newOrder[targetIndex]] = [newOrder[targetIndex], newOrder[index]];
                    setSectionOrder(newOrder);
                }
            };

            const saveNewPreset = () => {
                if (!newPresetName.trim()) return alert("Nama preset tidak boleh kosong!");
                const id = newPresetName.toLowerCase().replace(/\s+/g, '_');
                
                const newTemplate = {
                    label: newPresetName,
                    opening: templateConfig.opening.text,
                    conditions: templateConfig.conditions.text,
                    priceLabel: templateConfig.priceLabel.text,
                    linkLabel: templateConfig.linkLabel.text,
                    placeholder: "Contoh Produk..."
                };

                setTemplates(prev => ({ ...prev, [id]: newTemplate }));
                setSelectedCategory(id);
                setNewPresetName("");
                setShowSavePreset(false);
                alert(`Preset "${newPresetName}" berhasil disimpan!`);
            };

            const generateID = () => {
                const { prefix, mode, startSeq } = idSettings;
                let idBody = "";
                if (mode === 'sequential') {
                    idBody = startSeq.toString().padStart(4, '0');
                } else {
                    const min = 10000;
                    const max = 99999;
                    idBody = Math.floor(min + Math.random() * (max - min + 1)).toString();
                }
                return prefix ? `${prefix}-${idBody}` : idBody;
            };

            const generateNewResult = () => {
                if (!captionInput.trim()) {
                    alert("Harap isi caption terlebih dahulu!");
                    return;
                }
                
                const newId = generateID();
                let processedText = processSpintax(captionInput);
                
                if (selectedTone) {
                    processedText = applyAiTone(processedText, selectedTone);
                }
                
                setCurrentItem({ id: newId, text: processedText });
                
                if (idSettings.mode === 'sequential') {
                    setIdSettings(prev => ({ ...prev, startSeq: parseInt(prev.startSeq) + 1 }));
                }
                
                setMobileView('results');
            };

            const handleCopy = () => {
                if (!currentItem) return;
                const fullText = `${currentItem.text}\n_ID: ${currentItem.id}_`;
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = fullText;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        setIsCopied(true);
                        setTimeout(() => {
                            setIsCopied(false);
                            generateNewResult();
                        }, 1000);
                    }
                } catch (err) { console.error(err); }
            };

            const applyFormatting = (format) => {
                const textarea = resultTextAreaRef.current;
                if (!textarea) return;

                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const sel = textarea.value.substring(start, end);
                if (!sel) return;

                let wrapper = "";
                if (format === 'bold') wrapper = "*";
                if (format === 'italic') wrapper = "_";
                if (format === 'strike') wrapper = "~";
                if (format === 'mono') wrapper = "```";

                const newText = textarea.value.substring(0, start) + wrapper + sel + wrapper + textarea.value.substring(end);
                
                const idSuffix = `\n_ID: ${currentItem.id}_`;
                const textOnly = newText.replace(idSuffix, "");
                
                setCurrentItem({ ...currentItem, text: textOnly });
                textarea.focus();
            };

            const openWA = () => {
                if (!currentItem) return;
                const fullText = `${currentItem.text}\n_ID: ${currentItem.id}_`;
                window.open(`https://wa.me/?text=${encodeURIComponent(fullText)}`, '_blank');
            };

            const exportCSV = () => {
                if (!captionInput.trim()) return alert("Isi caption terlebih dahulu!");
                const exportBatch = [];
                let currentSeq = parseInt(idSettings.startSeq);
                for(let i=0; i<50; i++) {
                    let idBody = idSettings.mode === 'sequential' ? (currentSeq + i).toString().padStart(4, '0') : Math.floor(10000 + Math.random() * 89999).toString();
                    let finalId = idSettings.prefix ? `${idSettings.prefix}-${idBody}` : idBody;
                    let processedText = processSpintax(captionInput);
                    if(selectedTone) processedText = applyAiTone(processedText, selectedTone);
                    exportBatch.push({ id: finalId, text: processedText });
                }
                let csvContent = "data:text/csv;charset=utf-8,ID,Caption\n";
                exportBatch.forEach(row => {
                    const safeText = row.text.replace(/"/g, '""'); 
                    csvContent += `${row.id},"${safeText}"\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "caption_stok.csv");
                document.body.appendChild(link);
                link.click();
            };

            const toggleSection = (key) => {
                setTemplateConfig(prev => ({ ...prev, [key]: { ...prev[key], enabled: !prev[key].enabled } }));
            };
            
            const updateSectionText = (key, text) => {
                setTemplateConfig(prev => ({ ...prev, [key]: { ...prev[key], text } }));
            };

            const renderSectionHeaderButtons = (id, index) => (
                <div className="flex gap-1 ml-auto">
                    <button 
                        onClick={() => moveSection(index, 'up')} 
                        disabled={index === 0}
                        className={`p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition ${index === 0 ? 'opacity-30 cursor-not-allowed' : 'text-gray-500 dark:text-gray-400'}`}
                    >
                        <Icon path={paths.arrowUp} size={12}/>
                    </button>
                    <button 
                        onClick={() => moveSection(index, 'down')} 
                        disabled={index === sectionOrder.length - 1}
                        className={`p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition ${index === sectionOrder.length - 1 ? 'opacity-30 cursor-not-allowed' : 'text-gray-500 dark:text-gray-400'}`}
                    >
                        <Icon path={paths.arrowDown} size={12}/>
                    </button>
                </div>
            );

            const renderTemplateSection = (key, label, placeholder, index) => {
                const config = templateConfig[key];
                const isEditing = editingSection === key;

                return (
                    <div className="bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-lg p-3 shadow-sm transition-all hover:border-blue-300 dark:hover:border-blue-700">
                        <div className="flex items-center mb-2">
                            <label className="flex items-center gap-2 cursor-pointer select-none mr-2">
                                <input type="checkbox" checked={config.enabled} onChange={() => toggleSection(key)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700" />
                                <span className={`text-xs font-bold uppercase tracking-wider ${config.enabled ? 'text-gray-700 dark:text-gray-200' : 'text-gray-400 line-through'}`}>{label}</span>
                            </label>
                            
                            <button onClick={() => setEditingSection(isEditing ? null : key)} className={`p-1.5 rounded transition mr-2 ${isEditing ? 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300' : 'text-gray-400 hover:text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-800'}`} title="Edit Template Spintax">
                                {isEditing ? <Icon path={paths.check} size={14}/> : <Icon path={paths.edit} size={14}/>}
                            </button>

                            {renderSectionHeaderButtons(key, index)}
                        </div>
                        {config.enabled && (
                            <div className="animate-fade-in">
                                {isEditing ? (
                                    <textarea className="w-full p-2 border border-blue-200 dark:border-blue-800 rounded bg-blue-50/50 dark:bg-blue-900/10 text-[11px] font-mono text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-1 focus:ring-blue-400" rows="3" value={config.text} onChange={(e) => updateSectionText(key, e.target.value)} placeholder={placeholder} />
                                ) : (
                                    <div className="text-[10px] text-gray-500 dark:text-gray-400 font-mono bg-gray-50 dark:bg-gray-800/50 p-2 rounded border border-gray-100 dark:border-gray-700 truncate cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition" onClick={() => setEditingSection(key)} title="Klik untuk edit">
                                        {config.text}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            const renderInputSection = (id, label, content, index) => (
                <div className="bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 shadow-sm hover:border-blue-300 dark:hover:border-blue-700 transition-all">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-xs font-bold text-gray-600 dark:text-gray-400">{label}</label>
                        {renderSectionHeaderButtons(id, index)}
                    </div>
                    {content}
                </div>
            );

            return (
                <div className="h-dvh flex flex-col overflow-hidden">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-700 to-blue-600 dark:from-gray-900 dark:to-gray-800 p-3 md:p-4 text-white shadow-md shrink-0 z-20 transition-colors">
                        <div className="max-w-7xl mx-auto flex flex-row justify-between items-center gap-2">
                            <div className="flex flex-col">
                                <h1 className="text-lg md:text-xl font-bold flex items-center gap-2">
                                    <Icon path={paths.bag} /> <span className="hidden md:inline">Generator Caption Ultimate Pro</span><span className="md:hidden">Caption Gen Pro</span>
                                </h1>
                                <p className="text-blue-100 dark:text-gray-400 text-[10px] hidden md:block">Tool jualan lengkap dengan AI Tone, Presets, WhatsApp, & Export Excel</p>
                            </div>
                            <div className="flex gap-2 items-center">
                                <button onClick={() => setDarkMode(!darkMode)} className="bg-white/10 hover:bg-white/20 p-2 rounded-full transition" title={darkMode ? "Mode Terang" : "Mode Gelap"}>
                                    {darkMode ? <Icon path={paths.sun} /> : <Icon path={paths.moon} />}
                                </button>
                                <button onClick={exportCSV} className="bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 shadow transition">
                                    <Icon path={paths.download} /> <span className="hidden md:inline">Export 50 CSV</span><span className="md:hidden">CSV</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Mobile Navigation Tabs */}
                    <div className="md:hidden flex bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border shrink-0">
                        <button onClick={() => setMobileView('input')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition ${mobileView === 'input' ? 'border-blue-600 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 dark:text-gray-400'}`}>
                            <Icon path={paths.edit} /> Input Data
                        </button>
                        <button onClick={() => setMobileView('results')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition relative ${mobileView === 'results' ? 'border-green-600 text-green-600 dark:text-green-400' : 'border-transparent text-gray-500 dark:text-gray-400'}`}>
                            <Icon path={paths.list} /> Hasil Generate
                            {currentItem && <span className="absolute top-2 right-4 w-2 h-2 bg-red-500 rounded-full"></span>}
                        </button>
                    </div>

                    <div className="flex-grow grid grid-cols-1 md:grid-cols-12 overflow-hidden max-w-7xl mx-auto w-full h-full relative">
                        
                        {/* LEFT COLUMN: INPUT */}
                        <div className={`md:col-span-5 bg-white dark:bg-dark-card border-r border-gray-200 dark:border-dark-border z-10 h-full overflow-y-auto custom-scrollbar ${mobileView === 'input' ? 'block' : 'hidden md:block'}`}>
                            <div className="p-4 space-y-4 pb-24 md:pb-20">
                                <div className="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                                    <button onClick={() => setActiveTab('manual')} className={`flex-1 py-2 text-sm font-bold rounded-md transition ${activeTab === 'manual' ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 dark:text-gray-400'}`}>Manual Input</button>
                                    <button onClick={() => setActiveTab('auto')} className={`flex-1 py-2 text-sm font-bold rounded-md transition ${activeTab === 'auto' ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 dark:text-gray-400'}`}>Otomatis</button>
                                </div>

                                {/* CATEGORY & PRESETS */}
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Kategori / Preset</label>
                                        <button onClick={() => setShowSavePreset(!showSavePreset)} className="text-[10px] flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:underline">
                                            <Icon path={paths.plus} size={10} /> Simpan Preset
                                        </button>
                                    </div>
                                    
                                    {showSavePreset && (
                                        <div className="flex gap-2 mb-2 animate-fade-in">
                                            <input type="text" placeholder="Nama Preset (Misal: Skincare)" className="flex-grow p-2 text-xs border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white" value={newPresetName} onChange={e => setNewPresetName(e.target.value)} />
                                            <button onClick={saveNewPreset} className="bg-blue-600 text-white px-3 rounded text-xs"><Icon path={paths.save} size={12} /></button>
                                        </div>
                                    )}

                                    <select value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)} className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg text-sm bg-white dark:bg-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none">
                                        {Object.keys(templates).map(key => (<option key={key} value={key}>{templates[key].label}</option>))}
                                    </select>
                                </div>

                                {activeTab === 'manual' ? (
                                    <div className="bg-white dark:bg-dark-card rounded-lg">
                                        <textarea className="w-full p-4 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm resize-none h-96 bg-transparent dark:text-gray-200" placeholder={`Paste caption Spintax disini...\nContoh: {Jual|Ready} Barang {Bagus|Murah}`} value={captionInput} onChange={(e) => setCaptionInput(e.target.value)} />
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        
                                        {/* Dynamic Sections rendering based on order */}
                                        {sectionOrder.map((sectionId, index) => {
                                            switch(sectionId) {
                                                case 'opening':
                                                    return <React.Fragment key={sectionId}>{renderTemplateSection('opening', 'Template Opening', '{Halo|Hai}', index)}</React.Fragment>;
                                                
                                                case 'productName':
                                                    return <React.Fragment key={sectionId}>{renderInputSection('productName', 'Nama Produk', 
                                                        <input type="text" className="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-1 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-gray-200" placeholder={templates[selectedCategory]?.placeholder || "Contoh..."} value={autoForm.productName} onChange={(e) => setAutoForm({...autoForm, productName: e.target.value})} />
                                                    , index)}</React.Fragment>;
                                                
                                                case 'description':
                                                    return <React.Fragment key={sectionId}>{renderInputSection('description', 'Deskripsi Tambahan', 
                                                        <textarea rows="2" className="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-1 focus:ring-blue-500 text-sm bg-white dark:bg-gray-700 dark:text-gray-200" placeholder="Warna merah, size L..." value={autoForm.description} onChange={(e) => setAutoForm({...autoForm, description: e.target.value})} />
                                                    , index)}</React.Fragment>;
                                                
                                                case 'conditions':
                                                    return <React.Fragment key={sectionId}>{renderTemplateSection('conditions', 'Template Kondisi/Ket.', '{Baru|Bekas}', index)}</React.Fragment>;
                                                
                                                case 'price':
                                                    return <React.Fragment key={sectionId}>
                                                        <div className="bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-lg p-3 shadow-sm hover:border-blue-300 dark:hover:border-blue-700 transition-all">
                                                            <div className="flex justify-between items-center mb-2">
                                                                <div className="flex-1">
                                                                    {renderTemplateSection('priceLabel', 'Label Harga', '{Harga|Price}', -1)} 
                                                                    {/* Note: Nested template section inside price block, reusing component but without move buttons on inner part */}
                                                                </div>
                                                                {renderSectionHeaderButtons('price', index)}
                                                            </div>
                                                            <div className="mt-2">
                                                                <input type="text" className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-transparent dark:text-gray-200" placeholder="Rp. 150.000" value={autoForm.price} onChange={(e) => setAutoForm({...autoForm, price: e.target.value})} />
                                                            </div>
                                                        </div>
                                                    </React.Fragment>;
                                                
                                                case 'link':
                                                    return <React.Fragment key={sectionId}>
                                                        <div className="bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-lg p-3 shadow-sm hover:border-blue-300 dark:hover:border-blue-700 transition-all">
                                                            <div className="flex justify-between items-center mb-2">
                                                                <div className="flex-1">
                                                                    {renderTemplateSection('linkLabel', 'Label Link', '{Link|Order}', -1)}
                                                                </div>
                                                                {renderSectionHeaderButtons('link', index)}
                                                            </div>
                                                            <div className="mt-2">
                                                                <input type="text" className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-transparent dark:text-gray-200" placeholder="shopee.co.id/..." value={autoForm.link} onChange={(e) => setAutoForm({...autoForm, link: e.target.value})} />
                                                            </div>
                                                        </div>
                                                    </React.Fragment>;
                                                
                                                case 'hashtags':
                                                    return <React.Fragment key={sectionId}>{renderInputSection('hashtags', 'Hashtag', 
                                                        <div>
                                                            <div className="flex items-center gap-1 mb-1 text-xs text-gray-500"><Icon path={paths.hash} /> (Pisahkan dengan koma)</div>
                                                            <input type="text" className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-sm dark:text-gray-200" placeholder="sepatu, murah, promo" value={hashtags} onChange={(e) => setHashtags(e.target.value)} />
                                                        </div>
                                                    , index)}</React.Fragment>;
                                                
                                                default: return null;
                                            }
                                        })}

                                        {/* Preview Box removed per request */}
                                    </div>
                                )}

                                <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div className="flex items-center gap-2 mb-3 text-gray-700 dark:text-gray-300 font-bold text-xs uppercase"><Icon path={paths.settings} /> Pengaturan ID Unik</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] text-gray-500 dark:text-gray-400 block mb-1">Prefix</label><input type="text" placeholder="Contoh: TOKO-" className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md text-xs bg-white dark:bg-gray-700 dark:text-gray-200" value={idSettings.prefix} onChange={(e) => setIdSettings({...idSettings, prefix: e.target.value})} /></div>
                                        <div><label className="text-[10px] text-gray-500 dark:text-gray-400 block mb-1">Mode ID</label><select className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md text-xs bg-white dark:bg-gray-700 dark:text-gray-200" value={idSettings.mode} onChange={(e) => setIdSettings({...idSettings, mode: e.target.value})}><option value="random">Acak</option><option value="sequential">Urut</option></select></div>
                                    </div>
                                    {idSettings.mode === 'sequential' && (<div className="mt-2 flex items-center gap-2"><label className="text-xs text-gray-500 dark:text-gray-400">Mulai dari:</label><input type="number" className="p-1 border border-gray-300 dark:border-gray-600 rounded w-20 text-xs bg-white dark:bg-gray-700 dark:text-gray-200" value={idSettings.startSeq} onChange={(e) => setIdSettings({...idSettings, startSeq: e.target.value})} /></div>)}
                                </div>

                                <div className="mb-8">
                                    <label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2 block">AI Magic Tone (Opsional)</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.keys(TONE_MODIFIERS).map(key => (
                                            <button 
                                                key={key}
                                                onClick={() => setSelectedTone(selectedTone === key ? '' : key)}
                                                className={`text-xs p-2 rounded border transition text-left ${selectedTone === key ? 'bg-blue-100 border-blue-500 text-blue-700 dark:bg-blue-900 dark:text-blue-200' : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300'}`}
                                            >
                                                <span className="block font-bold">{TONE_MODIFIERS[key].emojis[0]} {TONE_MODIFIERS[key].label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button onClick={generateNewResult} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg active:scale-95 transition mb-8"><Icon path={paths.wand} /> MULAILAH (GENERATE)</button>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: SINGLE RESULT */}
                        <div className={`md:col-span-7 flex flex-col bg-gray-50 dark:bg-dark-bg h-full overflow-hidden relative ${mobileView === 'results' ? 'block' : 'hidden md:flex'}`}>
                            
                            <div className="p-4 border-b border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card flex justify-between items-center shrink-0 z-10 shadow-sm">
                                <div className="flex items-center gap-2">
                                    <span className="bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 p-1.5 rounded-md"><Icon path={paths.edit} /></span>
                                    <div>
                                        <h3 className="text-sm font-bold text-gray-800 dark:text-gray-200">Hasil Caption Anda</h3>
                                        <p className="text-[10px] text-gray-400">Copy untuk mengganti otomatis</p>
                                    </div>
                                </div>
                                <button onClick={generateNewResult} className="text-xs text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-800 px-3 py-1.5 rounded border border-blue-200 dark:border-blue-900 transition flex items-center gap-1">
                                    <Icon path={paths.refresh} /> <span className="hidden sm:inline">Lewati / Ganti Baru</span>
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 md:p-8 flex items-start justify-center custom-scrollbar">
                                {!currentItem ? (
                                    <div className="flex flex-col items-center justify-center h-full text-gray-400 dark:text-gray-500 opacity-60 text-center">
                                        <Icon path={paths.wand} size={48} />
                                        <p className="mt-4 text-sm font-medium">Belum ada hasil.</p>
                                        <p className="text-xs mt-1">Masuk ke tab <b>Input Data</b> lalu klik tombol <b>Mulailah</b>.</p>
                                    </div>
                                ) : (
                                    <div className="w-full max-w-2xl bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg transition-all flex flex-col animate-fade-in relative">
                                        
                                        {/* Status Header */}
                                        <div className="px-5 py-3 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-t-xl flex justify-between items-center">
                                            <span className="text-xs font-bold text-gray-500 dark:text-gray-400 flex items-center gap-1">
                                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Siap Digunakan
                                            </span>
                                            <span className="font-mono font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded border border-blue-100 dark:border-blue-800">
                                                ID: {currentItem.id}
                                            </span>
                                        </div>

                                        {/* Formatting Toolbar (Nomor 3) */}
                                        <div className="px-3 py-2 border-b border-gray-100 dark:border-gray-700 flex gap-2 overflow-x-auto bg-white dark:bg-dark-card">
                                            <button onClick={() => applyFormatting('bold')} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300" title="Bold"><Icon path={paths.bold} size={14}/></button>
                                            <button onClick={() => applyFormatting('italic')} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300" title="Italic"><Icon path={paths.italic} size={14}/></button>
                                            <button onClick={() => applyFormatting('strike')} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300" title="Strikethrough"><Icon path={paths.strike} size={14}/></button>
                                            <button onClick={() => applyFormatting('mono')} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300" title="Monospace"><Icon path={paths.mono} size={14}/></button>
                                        </div>

                                        {/* Editable Text Area */}
                                        <div className="p-5 flex-grow">
                                            <textarea 
                                                ref={resultTextAreaRef}
                                                className="w-full font-mono text-sm md:text-base whitespace-pre-wrap leading-relaxed outline-none resize-none bg-transparent text-gray-800 dark:text-gray-200 min-h-[300px]"
                                                value={`${currentItem.text}\n_ID: ${currentItem.id}_`}
                                                onChange={(e) => {
                                                    const newRaw = e.target.value.replace(`\n_ID: ${currentItem.id}_`, '');
                                                    setCurrentItem({ ...currentItem, text: newRaw });
                                                }}
                                            />
                                        </div>

                                        {/* Big Action Buttons */}
                                        <div className="p-5 pt-0 flex flex-col sm:flex-row gap-3">
                                            <button 
                                                onClick={handleCopy}
                                                className={`flex-1 py-4 rounded-xl text-sm md:text-base font-bold flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg active:scale-[0.98] ${
                                                    isCopied 
                                                    ? 'bg-green-500 text-white border-transparent' 
                                                    : 'bg-blue-600 hover:bg-blue-700 text-white border-transparent'
                                                }`}
                                            >
                                                {isCopied ? (
                                                    <><Icon path={paths.check} size={20} /> Tersalin! Menyiapkan caption baru...</>
                                                ) : (
                                                    <><Icon path={paths.copy} size={20} /> Salin & Ganti Baru (Copy & Next)</>
                                                )}
                                            </button>
                                            
                                            <button 
                                                onClick={openWA}
                                                className="sm:w-auto w-full py-4 px-6 bg-green-500 hover:bg-green-600 text-white rounded-xl transition shadow-md flex items-center justify-center gap-2 font-bold"
                                            >
                                                <Icon path={paths.wa} size={20} /> <span className="sm:hidden inline">Kirim ke WA</span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CaptionGenerator />);
    </script>
</body>
</html>
